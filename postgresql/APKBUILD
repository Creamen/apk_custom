# Contributor: BARON David <db@crea.mn>
# Maintainer: BARON David <db@crea.mn>
pkgname=postgresql
pkgver=v9.6.7
pkgrel=0
pkgdesc="PostgreSQL"
url="https://www.postgresql.org"
arch="x86_64"
license="PostgreSQL"
depends="tzdata"
depends_dev="libressl-dev openldap-dev libxml2-dev libxslt-dev readline-dev icu-dev util-linux-dev libedit-dev zlib-dev bison flex libintl"
makedepends="$depends_dev"
install=""
subpackages=""
builddir="$srcdir/$pkgname-$pkgver"

prepare() {
	cd "$srcdir"
	git clone --single-branch -b REL9_6_7 https://git.postgresql.org/git/postgresql.git $pkgname-$pkgver
}

build() {
	cd "$builddir"
	git_hash="$(git log -1 --pretty='%h')"
	git_branch="$(git branch --list 'REL*' | grep '*' | grep -oE '[^ ]+' | tail -1)"
	export CFLAGS="-O3 -march=native"
	export CPPFLAGS="-O3 -march=native"
	# https://git.alpinelinux.org/cgit/aports/tree/main/postgresql/APKBUILD
	#		--with-extra-version="-${git_branch}-${git_hash}"       \

	./configure                                                	\
		--prefix=/usr						\
		--with-libedit-preferred				\
		--with-system-tzdata=/usr/share/zoneinfo		\
		--with-ldap                                             \
		--with-openssl                                          \
		--with-uuid=e2fs                                        \
		--with-libxml                                           \
		--with-libxslt                                          

	make -j16
}

check() {
	cd "$builddir"
}

dev() {
	cd "$builddir"
}

doc() {
	cd "$builddir"
}

package() {
	cd "$builddir"
	make DESTDIR="$pkgdir" install 
}

