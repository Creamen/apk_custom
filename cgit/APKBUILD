# Contributor: 
# Maintainer:
pkgname=cgit
pkgver=v1.1
pkgrel=0
pkgdesc="cgit - git frontend in C"
url="https://git.zx2c4.com/cgit/"
arch="all"
license="GPL"
depends="highlight lua-dev gettext-dev openssl-dev git libintl"
makedepends="$depends"
install=""
subpackages=""
builddir="$srcdir/$pkgname-$pkgver"

prepare() {
	cd "$srcdir"
	git clone -b $pkgver https://git.zx2c4.com/cgit $pkgname-$pkgver || return 1
}

build() {
	cd "$builddir"
	git submodule init
	git submodule update
	make get-git
	sed -i 's,CGIT_LIBS += -ldl,CGIT_LIBS += -ldl -lintl,g' cgit.mk
	make NO_REGEX=NeedsStartEnd -j16
}

check() {
	cd "$builddir"
}

dev() {
	cd "$builddir"
}

doc() {
	cd "$builddir"
}

package() {
	cd "$builddir"
	install -d "$pkgdir"/run/httpd/sites/cgit/cgit-css "$pkgdir"/run/httpd/sites/cgit/users || return 1
	strip cgit
	install cgit "$pkgdir"/run/httpd/sites/cgit || return 1
	install cgit-doc.css cgit.css cgit.png "$pkgdir"/run/httpd/sites/cgit/cgit-css || return 1
	install $srcdir/../ext/Parsedown.php \
		$srcdir/../ext/owner.sh \
		$srcdir/../ext/parseMarkdown_wrapper.php \
		$srcdir/../ext/syntax-highlighting.sh "$pkgdir"/run/httpd/sites/cgit || return 1
	install $srcdir/../ext/users/* "$pkgdir"/run/httpd/sites/cgit/users || return 1
}

